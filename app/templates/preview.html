{% extends "base.html" %}

{% block title %}Preview Paper - AI Question Generator{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Progress Bar -->
    <div class="mb-8">
        <div class="flex items-center">
            <div class="flex items-center text-green-600">
                <div class="rounded-full h-8 w-8 bg-green-600 text-white flex items-center justify-center text-sm font-medium">
                    <i class="fas fa-check text-sm"></i>
                </div>
                <span class="ml-2 text-sm font-medium">Upload Complete</span>
            </div>
            <div class="flex-1 h-1 bg-green-200 mx-4"></div>
            <div class="flex items-center text-green-600">
                <div class="rounded-full h-8 w-8 bg-green-600 text-white flex items-center justify-center text-sm font-medium">
                    <i class="fas fa-check text-sm"></i>
                </div>
                <span class="ml-2 text-sm font-medium">Configuration Complete</span>
            </div>
            <div class="flex-1 h-1 bg-green-200 mx-4"></div>
            <div class="flex items-center text-blue-600">
                <div class="rounded-full h-8 w-8 bg-blue-600 text-white flex items-center justify-center text-sm font-medium">3</div>
                <span class="ml-2 text-sm font-medium">Preview & Download</span>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Question Paper Preview</h2>
            <p class="text-gray-600">Review your generated question paper before downloading</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="editPaper()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                <i class="fas fa-edit mr-2"></i>Edit
            </button>
            <button onclick="downloadPaper('pdf')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                <i class="fas fa-file-pdf mr-2"></i>Download PDF
            </button>
            <button onclick="downloadPaper('docx')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                <i class="fas fa-file-word mr-2"></i>Download DOCX
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Main Paper Preview -->
        <div class="lg:col-span-3">
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <!-- Paper Header -->
                <div class="bg-gray-50 px-6 py-4 border-b">
                    <div class="text-center">
                        <h1 class="text-xl font-bold text-gray-900">XYZ UNIVERSITY</h1>
                        <div class="mt-2 grid grid-cols-2 gap-4 text-sm">
                            <div class="text-left">
                                <strong>Subject:</strong> {{ paper.subject }}<br>
                                <strong>Paper Title:</strong> {{ paper.title }}<br>
                                <strong>Max Marks:</strong> {{ paper.total_marks }}
                            </div>
                            <div class="text-right">
                                <strong>Date:</strong> {{ paper.created_at.strftime('%d/%m/%Y') }}<br>
                                <strong>Time:</strong> 3 Hours<br>
                                <strong>Difficulty:</strong> {{ paper.difficulty_level }}/10
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="px-6 py-4 border-b bg-blue-50">
                    <h3 class="font-bold text-gray-900 mb-2">INSTRUCTIONS:</h3>
                    <ol class="text-sm text-gray-700 space-y-1">
                        <li>1. Read all questions carefully before attempting.</li>
                        <li>2. All questions are compulsory.</li>
                        <li>3. Write your answers clearly and legibly.</li>
                        <li>4. Time management is crucial for completion.</li>
                        <li>5. This paper contains {{ questions|length }} questions for {{ paper.total_marks }} marks.</li>
                        <li>6. Follow NEP 2020 guidelines: Focus on understanding, application, and critical thinking.</li>
                    </ol>
                </div>

                <!-- Questions -->
                <div class="px-6 py-4">
                    {% for question in questions %}
                        <div class="question-item mb-6 p-4 border rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-bold text-gray-900">Q{{ loop.index }}.</span>
                                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">[{{ question.marks }} marks]</span>
                            </div>

                            <p class="text-gray-800 mb-3 leading-relaxed">{{ question.text }}</p>

                            {% if question.options and question.type == "mcq" %}
                                <div class="ml-6 space-y-1">
                                    <div class="text-gray-700">(a) {{ question.options[0] }}</div>
                                    <div class="text-gray-700">(b) {{ question.options[1] }}</div>
                                    <div class="text-gray-700">(c) {{ question.options[2] }}</div>
                                    <div class="text-gray-700">(d) {{ question.options[3] }}</div>
                                </div>
                            {% endif %}

                            <div class="mt-3 text-xs text-gray-500">
                                <span class="inline-block bg-gray-200 px-2 py-1 rounded mr-2">{{ question.topic }}</span>
                                <span class="inline-block bg-gray-200 px-2 py-1 rounded mr-2">{{ question.cognitive_level|title }}</span>
                                <span class="inline-block bg-gray-200 px-2 py-1 rounded">Difficulty: {{ question.difficulty }}/10</span>
                            </div>

                            <div class="mt-3 text-xs text-gray-400">
                                <div class="border-t border-dashed border-gray-300 pt-2">Answer space provided in exam</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <h3 class="font-bold text-gray-900 mb-4">Paper Statistics</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span>Total Questions:</span>
                        <span class="font-medium">{{ questions|length }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Total Marks:</span>
                        <span class="font-medium">{{ paper.total_marks }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Estimated Time:</span>
                        <span class="font-medium">3 Hours</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Difficulty Level:</span>
                        <span class="font-medium">{{ paper.difficulty_level }}/10</span>
                    </div>
                </div>
            </div>

            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="font-bold text-gray-900 mb-4">NEP 2020 Compliance</h3>
                <div class="text-center mb-4">
                    <div class="text-3xl font-bold text-green-600">85%</div>
                    <div class="text-sm text-gray-600">Compliance Score</div>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex items-center text-green-600">
                        <i class="fas fa-check mr-2"></i>
                        <span>Cognitive distribution balanced</span>
                    </div>
                    <div class="flex items-center text-green-600">
                        <i class="fas fa-check mr-2"></i>
                        <span>Application-based questions</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Download Modal -->
<div id="downloadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl">
        <div class="text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <span class="text-lg font-medium">Preparing your download...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function downloadPaper(format) {
        document.getElementById('downloadModal').style.display = 'flex';
        
        const formData = new FormData();
        formData.append('format', format);
        
        fetch(`/download/{{ paper.id }}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `{{ paper.title.replace(' ', '_') }}.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Download error:', error);
        })
        .finally(() => {
            document.getElementById('downloadModal').style.display = 'none';
        });
    }

    function editPaper() {
        if (confirm('Are you sure you want to edit the paper?')) {
            window.history.back();
        }
    }
</script>
{% endblock %}
